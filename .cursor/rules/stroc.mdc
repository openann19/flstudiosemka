---
alwaysApply: true
---
# FL Studio Web DAW Project Commit/Review Rules

## Non-Negotiables (Block PRs)
- ✅ Typecheck passes: `tsc --noEmit` produces no errors.
- ✅ No unhandled async: no-floating-promises, no-misused-promises.
- ✅ No implicit `any` in public APIs.
- ✅ No unused exports: unused locals/params blocked in `src/`, tolerated (warn) in tests/scripts.
- ✅ Unit tests green; ≥80% coverage on changed lines/paths.
- ✅ Security basics: no `eval`, no dynamic `Function`, URLs/HTML sinks must be sanitized.

## Escape Hatches (Allowed With Proof)
- `// @ts-expect-error <reason + ticket/issue>` (never use `@ts-ignore`).
- Non-null `!` only after a proper guard or invariant function.
- `any` allowed only at boundary I/O and immediately parsed/validated (zod/io-ts/etc).

## ESLint: Flat Strict Config (Airbnb+)
See `eslint.config.mjs`:
```js
import js from '@eslint/js';
import typescript from '@typescript-eslint/eslint-plugin';
import parser from '@typescript-eslint/parser';
import react from 'eslint-plugin-react';
import reactHooks from 'eslint-plugin-react-hooks';
import unusedImports from 'eslint-plugin-unused-imports';
import sonar from 'eslint-plugin-sonarjs';
import promise from 'eslint-plugin-promise';
import globals from 'globals';

export default [
  { ignores: ['node_modules/**','dist/**','.next/**','build/**','coverage/**','ios/**','android/**'] },
  js.configs.recommended,
  {
    files: ['**/*.{ts,tsx}'],
    languageOptions: {
      parser,
      parserOptions: {
        ecmaVersion: 'latest',
        sourceType: 'module',
        ecmaFeatures: { jsx: true },
      },
      globals: { ...globals.browser, ...globals.node },
    },
    plugins: {
      '@typescript-eslint': typescript,
      react,
      'react-hooks': reactHooks,
      'unused-imports': unusedImports,
      sonar,
      promise,
    },
    rules: {
      // Reliability / safety
      'promise/always-return': 'error',
      'promise/no-return-wrap': 'error',
      '@typescript-eslint/no-floating-promises': 'error',
      '@typescript-eslint/no-misused-promises': ['error', { checksVoidReturn: { attributes: false } }],
      '@typescript-eslint/consistent-type-imports': ['error', { prefer: 'type-imports' }],
      '@typescript-eslint/no-implied-eval': 'error',
      'no-eval': 'error',
      'no-new-func': 'error',
      'react-hooks/rules-of-hooks': 'error',
      'react-hooks/exhaustive-deps': ['error', { additionalHooks: '(useAsyncEffect|useDebouncedEffect)' }],
      'sonarjs/no-inverted-boolean-check': 'error',
      'sonarjs/no-collapsible-if': 'error',

      // Maintainability
      'unused-imports/no-unused-imports': 'error',
      '@typescript-eslint/no-unused-vars': ['error', { argsIgnorePattern: '^_', varsIgnorePattern: '^_' }],
      'no-console': ['error', { allow: ['warn','error'] }],

      // Strict with flexibility
      '@typescript-eslint/no-explicit-any': ['warn', { ignoreRestArgs: true }],
      '@typescript-eslint/require-await': 'warn',
      '@typescript-eslint/no-unsafe-assignment': 'warn',
      '@typescript-eslint/no-unsafe-member-access': 'warn',
      '@typescript-eslint/no-unsafe-call': 'warn',
      '@typescript-eslint/no-unsafe-return': 'warn',
      '@typescript-eslint/no-unsafe-argument': 'warn',
      '@typescript-eslint/no-unnecessary-condition': ['warn', { allowConstantLoopConditions: true }],
      '@typescript-eslint/ban-ts-comment': ['warn', { 'ts-expect-error': 'allow-with-description' }],
      'sonarjs/cognitive-complexity': ['warn', 15],
      complexity: ['warn', 12],
      'max-lines-per-function': ['warn', { max: 120, skipComments: true, skipBlankLines: true }],
      'max-params': ['warn', 5],

      // Prettier/React handled style
      'react/jsx-uses-react': 'off',
      'react/react-in-jsx-scope': 'off',
    },
  },
  // Test files: allow more freedom, maintain async safety
  {
    files: ['**/*.test.{ts,tsx}', '**/__tests__/**/*.{ts,tsx}'],
    rules: {
      'no-console': 'off',
      '@typescript-eslint/no-explicit-any': 'off',
      '@typescript-eslint/no-unused-vars': ['warn', { argsIgnorePattern: '^_' }],
    },
  },
  // Scripts/tools: relaxed, but warn on 'any'
  {
    files: ['scripts/**/*.{ts,tsx,js}'],
    rules: { 'no-console': 'off', '@typescript-eslint/no-explicit-any': 'warn' },
  },
];
```

## TypeScript Baseline: `tsconfig.base.json`
```json
{
  "compilerOptions": {
    "target": "ES2022",
    "lib": ["ES2022", "DOM"],
    "module": "ESNext",
    "moduleResolution": "Bundler",
    "jsx": "react-jsx",
    "strict": true,
    "noImplicitOverride": true,
    "noImplicitReturns": true,
    "noFallthroughCasesInSwitch": true,
    "useUnknownInCatchVariables": true,
    "noUncheckedIndexedAccess": true,
    "exactOptionalPropertyTypes": false,
    "noPropertyAccessFromIndexSignature": false,
    "forceConsistentCasingInFileNames": true,
    "importsNotUsedAsValues": "error",
    "skipLibCheck": true,
    "resolveJsonModule": true
  },
  "exclude": ["node_modules", "dist", "build", ".next"]
}
```
- `"noUncheckedIndexedAccess": true` — catches more bugs, worth the verbosity.
- `"noPropertyAccessFromIndexSignature": false` — too noisy for app code.
- `"exactOptionalPropertyTypes": false` — too churny unless publishing libs.

## Unused Code Rules
- In `src/`: `"noUnusedLocals": true`, `"noUnusedParameters": true` (enforced).
- In tests/scripts: allowed as warning (see ESLint config above).

## Commit Gates & Scripts (`package.json`)
```json
{
  "scripts": {
    "typecheck": "tsc -b --pretty false",
    "lint": "eslint . --max-warnings=0 --cache",
    "lint:soft": "eslint . --cache",
    "test": "vitest run --reporter=dot",
    "prepush": "pnpm typecheck && pnpm lint && pnpm test"
  }
}
```
_Husky support:_
```
npx husky add .husky/pre-push "pnpm prepush"
```

## Safe Patterns
- Good:
  ```ts
  const raw: unknown = await fetchJSON(url);
  const data = schema.parse(raw); // e.g., zod
  ```
- Allowed with proof:
  ```ts
  // @ts-expect-error: 3rd-party type bug, checked by guard (YYYY-MM-DD, link #ticket)
  thirdParty.fn(val as any);
  ```
- Not allowed:
  ```ts
  // @ts-ignore // ❌ never
  ```

## PR Checklist For Merge
- Types pass (no `@ts-ignore`).
- No unmanaged promises.
- Public APIs: full TypeScript types, all boundaries schema-validated.
- No new warning counts in `src/` without justification.
- Changed logic ≥80% test coverage.
- Security: never use `eval` or dynamic `Function`.
- All critical paths tested.

## Process Rationale
- Errors in review gate real bugs and unsafe changes.
- Warns highlight churn or future refactors.
- Commit gates and config prevent drift.

_Trade-off_: A few warnings might appear during heavy churn, but commit rules prevent them from landing. The checked flags (notably `noUncheckedIndexedAccess`) are verbose, but increase safety.
//
- End of Selection
```